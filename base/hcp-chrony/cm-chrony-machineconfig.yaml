apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: hcp-chrony-cm-chrony-machineconfig
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: >
    {{ range $cluster := (lookup "hypershift.openshift.io/v1beta1" "HostedCluster" "" "").items }}
      {{ $namespace := $cluster.metadata.namespace }}

      # Create ConfigMap which includes MachineConfig for chrony
      - complianceType: musthave
        objectDefinition:
          apiVersion: v1
          data:
            config: |-
              # Generated by Butane; do not edit
              apiVersion: machineconfiguration.openshift.io/v1
              kind: MachineConfig
              metadata:
                labels:
                  machineconfiguration.openshift.io/role: worker
                name: 99-worker-chrony
              spec:
                config:
                  ignition:
                    version: 3.2.0
                  storage:
                    files:
                      - contents:
                          compression: gzip
                          source: data:;base64,CHANGE_ME
                        mode: 420
                        overwrite: true
                        path: /etc/chrony.conf
          immutable: false
          kind: ConfigMap
          metadata:
            name: cm-chrony-machineconfig
            namespace: {{ $namespace }}
    {{ end }}
 